name: Daily IPv4 List Release

on:
  schedule:
    - cron: '0 18 * * *'  # UTC+0900 -> 03:00
  workflow_dispatch:

permissions:
  contents: write
  discussions: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
    - name: Check out repository
      uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v2
      with:
        go-version: '1.x'  

    - name: Restore cached Primes
      id: cache-primes-restore
      uses: actions/cache/restore@v3
      with:
        path: cache
        key: ${{ runner.os }}-primes

    - name: Run script and generate ipv4 tsv file
      run: |
        go build -o ./getipv4 &&
        ./getipv4|gzip --best> ipv4cidr.tsv.gz &&
        MASK=true ./getipv4|gzip --best> ipv4mask.tsv.gz
    
    - name: Save Primes
      id: cache-primes-save
      uses: actions/cache/save@v3
      with:
        path: cache
        key: ${{ steps.cache-primes-restore.outputs.cache-primary-key }}

    - name: Get the current date
      id: date
      # run: echo "::set-output name=date::$(date +'%Y-%m-%d')"
      run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_STATE

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.date.outputs.date }}
        name: Release ${{ steps.date.outputs.date }}
        draft: false
        prerelease: false
        files: |
          ipv4cidr.tsv.gz
          ipv4mask.tsv.gz

    - uses: sgpublic/delete-release-action@v1.1
      with:
        release-drop: true
        release-keep-count: 30
        release-drop-tag: true
        pre-release-drop: true
        pre-release-keep-count: -1
        pre-release-drop-tag: true
        draft-drop: true
        draft-drop-count: -1
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}